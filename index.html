<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Stick Fight Demo</title>
    <style>
      * { box-sizing: border-box; }
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, Arial, sans-serif;
        margin: 0;
        padding: 24px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
      }
      .container {
        max-width: 900px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.95);
        padding: 24px;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }
      h2 {
        margin-top: 0;
        color: #4c1d95;
        font-size: 28px;
        font-weight: 700;
        text-align: center;
        margin-bottom: 20px;
      }
      .row {
        display: flex;
        gap: 12px;
        margin-bottom: 16px;
        flex-wrap: wrap;
        align-items: center;
      }
      button {
        padding: 12px 20px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        border: none;
        border-radius: 8px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rg  w     ba(102, 126, 234, 0.4);
      }
      button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5);
      }
      button:active:not(:disabled) {
        transform: translateY(0);
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background: #9ca3af;
        box-shadow: none;
      }
      input, select {
        padding: 10px 14px;
        font-size: 14px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        transition: border-color 0.3s ease;
      }
      input:focus, select:focus {
        outline: none;
        border-color: #667eea;
      }
      #gameCanvas {
        border: 2px solid #667eea;
        border-radius: 12px;
        background: linear-gradient(180deg, #e0e7ff 0%, #f7f9fc 100%);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        display: block;
        margin: 0 auto;
      }
      #log {
        background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
        color: #e5ecff;
        padding: 16px;
        border-radius: 12px;
        min-height: 160px;
        white-space: pre-wrap;
        font-family: 'Courier New', monospace;
        font-size: 13px;
        line-height: 1.6;
        box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.3);
        max-height: 200px;
        overflow-y: auto;
      }
      #log::-webkit-scrollbar {
        width: 8px;
      }
      #log::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
      }
      #log::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 4px;
      }
      #log::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.5);
      }
      .hp {
        font-weight: bold;
        font-size: 16px;
        color: #4c1d95;
        padding: 12px;
        background: rgba(102, 126, 234, 0.1);
        border-radius: 8px;
        margin-bottom: 12px;
      }
      #actAttack {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
      }
      #actBlock {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
      }
      #actItem {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
      }

      .cooldown {
        opacity: 0.3 !important;
      }
      #btnBackSub {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
      }
    </style>
  </head>
  <body>
    <div class="container">
    <h2>Stick Fight</h2>
    <div id="menuRow" class="row">
      <input id="playerName" placeholder="Jouw naam" value="Speler" style="min-width:120px" />
      <button id="btnLocal">Local Play</button>
      <button id="btnHostOnline">Host Online</button>
      <button id="btnJoinOnline">Join Online</button>
      <button id="btnBack" disabled>Back</button>
    </div>
    <div id="hostRow" class="row" style="display:none">
      <input id="room" placeholder="Room code (bv. my-room)" />
      <button id="btnStartHost">Start</button>
      <button id="btnHostBack">Back</button>
    </div>
    <div id="waitingRow" class="row" style="display:none">
      <span id="waitingMsg" style="font-size:18px;color:#4c1d95;">Wachten op speler...</span>
    </div>
    <div id="joinRow" class="row" style="display:none">
      <button id="btnRefreshRooms">Refresh Rooms</button>
      <select id="roomsList" style="min-width:240px">
        <option value="">(geen open rooms)</option>
      </select>
      <button id="btnJoinRoom">Join</button>
      <button id="btnJoinBack">Back</button>
    </div>
    <div class="row" style="width:100%">
      <canvas id="gameCanvas" width="700" height="320" style="border:1px solid #ccc; background:#f7f9fc; width:100%; max-width:820px"></canvas>
    </div>
    <div id="actionRow" class="row">
      <button id="actAttack">Attack</button>
      <button id="actBlock">Block</button>
      <button id="actItem">Item</button>
      <button id="btnBackSub" style="display:none">Back</button>
      <!-- Sub-action buttons for attack -->
      <button id="subAttackNormal" style="display:none">Normal Attack</button>
      <button id="subAttackLight" style="display:none">Light Attack</button>
      <button id="subAttackHeavy" style="display:none">Heavy Attack</button>
      <!-- Sub-action buttons for item -->
      <button id="subItemHeal" style="display:none">Heal</button>
      <button id="subItemStrength" style="display:none">Strength Boost</button>
      <button id="subItemDefence" style="display:none">Defence Buff</button>
    </div>
    <div id="gameOverRow" class="row" style="display:none">
      <button id="btnPlayAgain">Nog een keer</button>
      <button id="btnBackToMenu">Terug</button>
    </div>
    <div id="state" class="hp"></div>
    <div id="log" aria-live="polite"></div>
    </div>

    <script src="Untitled-1.js"></script>
    <!-- Firebase compat SDKs (global firebase.*) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script>
      // Firebase config
      const firebaseConfig = {
        apiKey: "AIzaSyAs07dGS6aFqshNei3n2edxnaBLrSsfRvA",
        authDomain: "stick-ficht.firebaseapp.com",
        projectId: "stick-ficht",
        storageBucket: "stick-ficht.firebasestorage.app",
        messagingSenderId: "198218024025",
        appId: "1:198218024025:web:b1ade6fd2ab57f6a42dd48",
        measurementId: "G-JCY8JXHB1W"
      };
      let db = null;
      if (firebaseConfig) {
        const app = firebase.initializeApp(firebaseConfig);
        db = firebase.firestore(app);
        window.__db = db;
      }
    </script>
    <script>
      (function() {
        const logEl = document.getElementById('log');
        const stateEl = document.getElementById('state');
        const originalLog = console.log.bind(console);
        console.log = function(...args) {
          originalLog(...args);
          const line = args.map(String).join(' ');
          logEl.textContent += (logEl.textContent ? '\n' : '') + line;
          logEl.scrollTop = logEl.scrollHeight;
        };

        function currentName() {
          return document.getElementById('playerName').value || 'Speler';
        }

        // Initialize game
        window.game = new Game(currentName());

        // Update game.playerName live when changed
        document.getElementById('playerName').addEventListener('input', function() {
          if (window.game) {
            window.game.playerName = this.value || 'Speler';
            window.game.drawState();
          }
        });

        // UI helpers
        function showMenu() {
          document.getElementById('menuRow').style.display = '';
          document.getElementById('hostRow').style.display = 'none';
          document.getElementById('waitingRow').style.display = 'none';
          document.getElementById('joinRow').style.display = 'none';
          document.getElementById('btnBack').disabled = true;
        }
        function showHost() {
          document.getElementById('menuRow').style.display = 'none';
          document.getElementById('hostRow').style.display = '';
          document.getElementById('waitingRow').style.display = 'none';
          document.getElementById('joinRow').style.display = 'none';
          document.getElementById('btnBack').disabled = false;
        }
        function showWaiting() {
          document.getElementById('menuRow').style.display = 'none';
          document.getElementById('hostRow').style.display = 'none';
          document.getElementById('waitingRow').style.display = '';
          document.getElementById('joinRow').style.display = 'none';
          document.getElementById('btnBack').disabled = false;
        }
        function showJoin() {
          document.getElementById('menuRow').style.display = 'none';
          document.getElementById('hostRow').style.display = 'none';
          document.getElementById('waitingRow').style.display = 'none';
          document.getElementById('joinRow').style.display = '';
          document.getElementById('btnBack').disabled = false;
        }
        function hideAllMenus() {
          document.getElementById('menuRow').style.display = 'none';
          document.getElementById('hostRow').style.display = 'none';
          document.getElementById('waitingRow').style.display = 'none';
          document.getElementById('joinRow').style.display = 'none';
        }
        window.__resetToMenu = showMenu;

        // Local Play flow
        document.getElementById('btnLocal').onclick = function() {
          window.game = new Game(currentName());
          window.game.startLocal();
          hideAllMenus();
          updateButtonStates();
        };

        // Host Online flow
        document.getElementById('btnHostOnline').onclick = function() {
          showHost();
        };
        document.getElementById('btnStartHost').onclick = function() {
          const room = document.getElementById('room').value || 'room-1';
          if (!window.__db) {
            console.log('Vul eerst je Firebase config in (index.html).');
            return;
          }
          window.game = new Game(currentName());
          window.game.__waitingForJoin = true;
          window.game.startOnline(window.__db, room, true);
          showWaiting();
          updateButtonStates();
        };
        document.getElementById('btnHostBack').onclick = function() {
          showMenu();
        };

        // Show waiting until opponent joins
        window.__onOpponentJoined = function() {
          hideAllMenus();
          updateButtonStates();
        };

        // Join Online flow
        document.getElementById('btnJoinOnline').onclick = function() {
          showJoin();
          refreshRooms();
        };
        document.getElementById('btnRefreshRooms').onclick = refreshRooms;

        async function refreshRooms() {
          if (!window.__db) {
            console.log('Firebase niet geinitialiseerd. Vul config in.');
            return;
          }
          const select = document.getElementById('roomsList');
          select.innerHTML = '';
          try {
            let snap;
            try {
              snap = await window.__db
                .collection('rooms')
                .where('state','==','matchmaking')
                .orderBy('updatedAt','desc')
                .limit(50)
                .get();
            } catch (err) {
              console.log('Firestore index ontbreekt, client-side filter/sort wordt gebruikt.');
              snap = await window.__db.collection('rooms').limit(200).get();
              const docs = snap.docs
                .map(d => ({ id: d.id, data: d.data() }))
                .filter(x => x.data && x.data.state === 'matchmaking')
                .sort((a, b) => (b.data.updatedAt || 0) - (a.data.updatedAt || 0));
              if (docs.length === 0) {
                const opt = document.createElement('option');
                opt.value = '';
                opt.textContent = '(geen open rooms)';
                select.appendChild(opt);
              } else {
                docs.forEach(({ id, data }) => {
                  const roomId = id.replace(/^stickfight_/, '');
                  const label = `${roomId} — host: ${data.hostName || '?'} (turn ${data.turn || 1})`;
                  const opt = document.createElement('option');
                  opt.value = roomId;
                  opt.textContent = label;
                  select.appendChild(opt);
                });
              }
              return;
            }
            let found = false;
            if (!snap.empty) {
              snap.forEach(doc => {
                const data = doc.data();
                const id = doc.id.replace(/^stickfight_/, '');
                const label = `${id} — host: ${data.hostName || '?'} (turn ${data.turn || 1})`;
                const opt = document.createElement('option');
                opt.value = id;
                opt.textContent = label;
                select.appendChild(opt);
                found = true;
              });
            }
            if (!found) {
              const opt = document.createElement('option');
              opt.value = '';
              opt.textContent = '(geen open rooms)';
              select.appendChild(opt);
            }
          } catch (e) {
            select.innerHTML = '';
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = '(laden faalde)';
            select.appendChild(opt);
            console.log('Rooms laden faalde:', e && e.message ? e.message : e);
          }
        }

        document.getElementById('roomsList').onchange = function() {
          const val = this.value;
          if (!val) return;
          if (!window.__db) {
            console.log('Vul eerst je Firebase config in (index.html).');
            return;
          }
          window.game = new Game(currentName());
          window.game.startOnline(window.__db, val, false);
          hideAllMenus();
          updateButtonStates();
        };

        document.getElementById('btnJoinRoom').onclick = function() {
          const select = document.getElementById('roomsList');
          const val = select.value;
          if (!val) return;
          if (!window.__db) {
            console.log('Vul eerst je Firebase config in (index.html).');
            return;
          }
          window.game = new Game(currentName());
          window.game.startOnline(window.__db, val, false);
          hideAllMenus();
          updateButtonStates();
        };

        document.getElementById('btnJoinBack').onclick = function() {
          showMenu();
        };

        document.getElementById('btnBack').onclick = async function() {
          if (window.game && typeof window.game.onBack === 'function') {
            await window.game.onBack();
          }
          showMenu();
        };

        // Action button handlers
        document.getElementById('actAttack').addEventListener('click', () => {
          // Show sub-actions for both local and online play
          ['actAttack','actBlock','actItem'].forEach(id => {
            document.getElementById(id).style.display = 'none';
          });
          document.getElementById('btnBackSub').style.display = 'inline-block';
          ['subAttackNormal','subAttackLight','subAttackHeavy'].forEach(id => {
            document.getElementById(id).style.display = 'inline-block';
            document.getElementById(id).disabled = false;
          });
          updateButtonStates();
        });

        document.getElementById('actBlock').addEventListener('click', () => {
          window.game.submitAction('block');
          updateButtonStates();
        });

        document.getElementById('actItem').addEventListener('click', () => {
          // Show sub-actions for both local and online play
          ['actAttack','actBlock','actItem'].forEach(id => {
            document.getElementById(id).style.display = 'none';
          });
          document.getElementById('btnBackSub').style.display = 'inline-block';
          ['subItemHeal','subItemStrength','subItemDefence'].forEach(id => {
            document.getElementById(id).style.display = 'inline-block';
            document.getElementById(id).disabled = false;
          });
          updateButtonStates();
        });



        document.getElementById('btnBackSub').addEventListener('click', () => {
          resetToMainActions();
          updateButtonStates();
        });

        // Sub-action handlers for attack
        document.getElementById('subAttackNormal').addEventListener('click', () => {
          window.game.submitAction({ type: 'attack', sub: 'normal' });
          resetToMainActions();
          updateButtonStates();
        });
        document.getElementById('subAttackLight').addEventListener('click', () => {
          window.game.submitAction({ type: 'attack', sub: 'light' });
          resetToMainActions();
          updateButtonStates();
        });
        document.getElementById('subAttackHeavy').addEventListener('click', () => {
          window.game.submitAction({ type: 'attack', sub: 'heavy' });
          resetToMainActions();
          updateButtonStates();
        });

        // Sub-action handlers for item
        document.getElementById('subItemHeal').addEventListener('click', () => {
          window.game.submitAction({ type: 'item', sub: 'heal' });
          resetToMainActions();
          updateButtonStates();
        });
        document.getElementById('subItemStrength').addEventListener('click', () => {
          window.game.submitAction({ type: 'item', sub: 'strength' });
          resetToMainActions();
          updateButtonStates();
        });
        document.getElementById('subItemDefence').addEventListener('click', () => {
          window.game.submitAction({ type: 'item', sub: 'defence' });
          resetToMainActions();
          updateButtonStates();
        });

        // Helper functions
        function resetToMainActions() {
          // Hide sub-action buttons
          ['subAttackNormal','subAttackLight','subAttackHeavy',
           'subItemHeal','subItemStrength','subItemDefence'].forEach(id => {
            document.getElementById(id).style.display = 'none';
          });
          // Hide back sub button
          document.getElementById('btnBackSub').style.display = 'none';
          // Show main action buttons
          ['actAttack','actBlock','actItem'].forEach(id => {
            document.getElementById(id).style.display = '';
          });
        }

        function updateButtonStates() {
          if (!window.game) return;

          let enable = false;
          if (!window.game.isOnline) {
            // Local play: enable when playing and no action chosen
            enable = window.game.state === 'playing' && !window.game.playerAction;
          } else {
            // Online play: enable only when playing and no action chosen
            enable = window.game.state === 'playing' && !window.game.playerAction;
          }

          ['actAttack','actBlock','actItem'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
              el.disabled = !enable;
              // Apply cooldown visual - main button dimmed only if ALL sub-actions are on cooldown
              let isOnCooldown = false;
              if (window.game.playerCooldowns) {
                const actionType = id.replace('act', '').toLowerCase();
                if (actionType === 'parry') {
                  isOnCooldown = window.game.playerCooldowns['parry'] > 0;
                } else if (actionType === 'attack') {
                  isOnCooldown = ['attack_normal', 'attack_light', 'attack_heavy'].every(key => window.game.playerCooldowns[key] > 0);
                } else if (actionType === 'item') {
                  isOnCooldown = ['item_heal', 'item_speed', 'item_defence'].every(key => window.game.playerCooldowns[key] > 0);
                } else if (actionType === 'block') {
                  isOnCooldown = false; // block has no cooldown
                }
              }
              if (isOnCooldown) {
                el.classList.add('cooldown');
              } else {
                el.classList.remove('cooldown');
              }
            }
          });

          // Update sub-button states based on specific cooldowns
          const subButtons = [
            { id: 'subAttackNormal', cooldownKey: 'attack_normal' },
            { id: 'subAttackLight', cooldownKey: 'attack_light' },
            { id: 'subAttackHeavy', cooldownKey: 'attack_heavy' },
            { id: 'subItemHeal', cooldownKey: 'item_heal' },
            { id: 'subItemSpeed', cooldownKey: 'item_speed' },
            { id: 'subItemDefence', cooldownKey: 'item_defence' }
          ];
          subButtons.forEach(({ id, cooldownKey }) => {
            const el = document.getElementById(id);
            if (el) {
              const isOnCooldown = window.game.playerCooldowns && window.game.playerCooldowns[cooldownKey] > 0;
              if (isOnCooldown) {
                el.classList.add('cooldown');
              } else {
                el.classList.remove('cooldown');
              }
            }
          });

          // Update state display
          stateEl.textContent = `State: ${window.game.state} | You: ${window.game.playerHP} HP vs Opponent: ${window.game.opponentHP} HP`;
        }

        // Initial state update
        updateButtonStates();

        // Periodic UI sync
        setInterval(updateButtonStates, 100);

        // Game over handlers
        document.getElementById('btnPlayAgain').addEventListener('click', () => {
          if (window.game && window.game.isOnline) {
            // For online games, signal play again
            window.game.signalPlayAgain();
          } else {
            // For local games, restart immediately
            window.game = new Game(currentName());
            window.game.startLocal();
            hideAllMenus();
            document.getElementById('gameOverRow').style.display = 'none';
            updateButtonStates();
          }
        });

        document.getElementById('btnBackToMenu').addEventListener('click', () => {
          if (window.game && window.game.isOnline) {
            // For online games, signal back to menu
            window.game.signalBackToMenu();
          } else {
            // For local games, go back to menu
            showMenu();
            document.getElementById('gameOverRow').style.display = 'none';
          }
        });

        // Expose functions for Game class
        window.__enableActions = updateButtonStates;
        window.__resetToMenu = showMenu;
        window.__onOpponentJoined = function() {
          hideAllMenus();
          updateButtonStates();
        };
        window.__showGameOver = function() {
          document.getElementById('gameOverRow').style.display = '';
          // Disable action buttons
          ['actAttack','actBlock','actItem'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.disabled = true;
          });
        };
        window.__showHostGameOverOptions = function() {
          document.getElementById('gameOverRow').style.display = '';
          // Disable action buttons
          ['actAttack','actBlock','actItem'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.disabled = true;
          });
        };
        window.__hideGameOver = function() {
          document.getElementById('gameOverRow').style.display = 'none';
        };

      })();
    </script>
  </body>
</html>
