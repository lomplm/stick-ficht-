<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Stick Fight Demo</title>
    <style>
      * { box-sizing: border-box; }
      body { 
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, Arial, sans-serif; 
        margin: 0;
        padding: 24px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
      }
      .container {
        max-width: 900px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.95);
        padding: 24px;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }
      h2 {
        margin-top: 0;
        color: #4c1d95;
        font-size: 28px;
        font-weight: 700;
        text-align: center;
        margin-bottom: 20px;
      }
      .row { 
        display: flex; 
        gap: 12px; 
        margin-bottom: 16px; 
        flex-wrap: wrap;
        align-items: center;
      }
      button { 
        padding: 12px 20px; 
        font-size: 14px; 
        font-weight: 600;
        cursor: pointer;
        border: none;
        border-radius: 8px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      }
      button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5);
      }
      button:active:not(:disabled) {
        transform: translateY(0);
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background: #9ca3af;
        box-shadow: none;
      }
      input, select {
        padding: 10px 14px;
        font-size: 14px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        transition: border-color 0.3s ease;
      }
      input:focus, select:focus {
        outline: none;
        border-color: #667eea;
      }
      #gameCanvas {
        border: 2px solid #667eea;
        border-radius: 12px;
        background: linear-gradient(180deg, #e0e7ff 0%, #f7f9fc 100%);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        display: block;
        margin: 0 auto;
      }
      #log { 
        background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
        color: #e5ecff; 
        padding: 16px; 
        border-radius: 12px; 
        min-height: 160px; 
        white-space: pre-wrap;
        font-family: 'Courier New', monospace;
        font-size: 13px;
        line-height: 1.6;
        box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.3);
        max-height: 200px;
        overflow-y: auto;
      }
      #log::-webkit-scrollbar {
        width: 8px;
      }
      #log::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
      }
      #log::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 4px;
      }
      #log::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.5);
      }
      .hp { 
        font-weight: bold;
        font-size: 16px;
        color: #4c1d95;
        padding: 12px;
        background: rgba(102, 126, 234, 0.1);
        border-radius: 8px;
        margin-bottom: 12px;
      }
      #actAttack {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
      }
      #actBlock {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
      }
      #actItem {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
      }
      #actRun {
        background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        box-shadow: 0 4px 12px rgba(107, 114, 128, 0.4);
      }
    </style>
  </head>
  <body>
    <div class="container">
    <h2>Stick Fight</h2>
    <div id="menuRow" class="row">
      <input id="playerName" placeholder="Jouw naam" value="Speler" style="min-width:120px" />
      <button id="btnHostOnline">Host Online</button>
      <button id="btnJoinOnline">Join Online</button>
      <button id="btnBack" disabled>Back</button>
    </div>
    <div id="hostRow" class="row" style="display:none">
      <input id="room" placeholder="Room code (bv. my-room)" />
      <button id="btnStartHost">Start</button>
      <button id="btnHostBack">Back</button>
    </div>
    <div id="waitingRow" class="row" style="display:none">
      <span id="waitingMsg" style="font-size:18px;color:#4c1d95;">Wachten op speler...</span>
    </div>
    <div id="joinRow" class="row" style="display:none">
      <button id="btnRefreshRooms">Refresh Rooms</button>
      <select id="roomsList" style="min-width:240px">
        <option value="">(geen open rooms)</option>
      </select>
      <button id="btnJoinRoom">Join</button>
      <button id="btnJoinBack">Back</button>
    </div>
    <div class="row" style="width:100%">
      <canvas id="gameCanvas" width="700" height="320" style="border:1px solid #ccc; background:#f7f9fc; width:100%; max-width:820px"></canvas>
    </div>
    <div class="row">
      <button id="actAttack" disabled>Attack</button>
      <button id="actBlock" disabled>Block</button>
      <button id="actItem" disabled>Item</button>
      <button id="actRun" disabled>Run</button>
      <!-- Sub-action buttons for attack -->
      <button id="subAttackPunch" style="display:none">Punch</button>
      <button id="subAttackKick" style="display:none">Kick</button>
      <button id="subAttackUppercut" style="display:none">Uppercut</button>
      <button id="subAttackSpecial" style="display:none">Special</button>
      <!-- Sub-action buttons for item -->
      <button id="subItemHeal" style="display:none">Heal</button>
      <button id="subItemSpeed" style="display:none">Speed Boost</button>
      <button id="subItemDefence" style="display:none">Defence Buff</button>
    </div>
    <div id="state" class="hp"></div>
    <div id="log" aria-live="polite"></div>
    </div>

    <script src="Untitled-1.js"></script>
    <!-- Firebase compat SDKs (global firebase.*) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script>
      // 1) Vul je Firebase config hieronder in (Project settings -> Your apps -> SDK setup and configuration)
      // Voorbeeld:
      // const firebaseConfig = { apiKey: "...", authDomain: "...", projectId: "...", storageBucket: "...", messagingSenderId: "...", appId: "..." };
      const firebaseConfig = {
        apiKey: "AIzaSyAs07dGS6aFqshNei3n2edxnaBLrSsfRvA",
        authDomain: "stick-ficht.firebaseapp.com",
        projectId: "stick-ficht",
        storageBucket: "stick-ficht.firebasestorage.app",
        messagingSenderId: "198218024025",
        appId: "1:198218024025:web:b1ade6fd2ab57f6a42dd48",
        measurementId: "G-JCY8JXHB1W"
      };
      let db = null;
      if (firebaseConfig) {
        const app = firebase.initializeApp(firebaseConfig);
        db = firebase.firestore(app);
        window.__db = db; // maak beschikbaar voor game code
      }
    </script>
    <script>
      (function() {
        const logEl = document.getElementById('log');
        const stateEl = document.getElementById('state');
        const originalLog = console.log.bind(console);
        console.log = function(...args) {
          originalLog(...args);
          const line = args.map(String).join(' ');
          logEl.textContent += (logEl.textContent ? '\n' : '') + line;
          logEl.scrollTop = logEl.scrollHeight;
        };

        const nameInput = document.getElementById('playerName');
        function currentName() {
          return document.getElementById('playerName').value || 'Speler';
        }
        let game = new Game(currentName());

        // Update game.playerName live when changed
        document.getElementById('playerName').addEventListener('input', function() {
          if (game) {
            game.playerName = this.value || 'Speler';
            game.drawState();
          }
        });

        // UI helpers
        function showMenu() {
          document.getElementById('menuRow').style.display = '';
          document.getElementById('hostRow').style.display = 'none';
          document.getElementById('waitingRow').style.display = 'none';
          document.getElementById('joinRow').style.display = 'none';
          document.getElementById('btnBack').disabled = true;
        }
        function showHost() {
          document.getElementById('menuRow').style.display = 'none';
          document.getElementById('hostRow').style.display = '';
          document.getElementById('waitingRow').style.display = 'none';
          document.getElementById('joinRow').style.display = 'none';
          document.getElementById('btnBack').disabled = false;
        }
        function showWaiting() {
          document.getElementById('menuRow').style.display = 'none';
          document.getElementById('hostRow').style.display = 'none';
          document.getElementById('waitingRow').style.display = '';
          document.getElementById('joinRow').style.display = 'none';
          document.getElementById('btnBack').disabled = false;
        }
        function showJoin() {
          document.getElementById('menuRow').style.display = 'none';
          document.getElementById('hostRow').style.display = 'none';
          document.getElementById('waitingRow').style.display = 'none';
          document.getElementById('joinRow').style.display = '';
          document.getElementById('btnBack').disabled = false;
        }
        function hideAllMenus() {
          document.getElementById('menuRow').style.display = 'none';
          document.getElementById('hostRow').style.display = 'none';
          document.getElementById('waitingRow').style.display = 'none';
          document.getElementById('joinRow').style.display = 'none';
        }
        window.__resetToMenu = showMenu;

        // Host Online flow
        document.getElementById('btnHostOnline').onclick = function() {
          showHost();
        };
        document.getElementById('btnStartHost').onclick = function() {
          const room = document.getElementById('room').value || 'room-1';
          if (!window.__db) {
            console.log('Vul eerst je Firebase config in (index.html).');
            return;
          }
          game = new Game(currentName());
          game.__waitingForJoin = true;
          game.startOnline(window.__db, room, true);
          showWaiting();
        };
        document.getElementById('btnHostBack').onclick = function() {
          showMenu();
        };

        // Show waiting until opponent joins (called from Game when opponent joins)
        window.__onOpponentJoined = function() {
          hideAllMenus();
        };

        // Join Online flow
        document.getElementById('btnJoinOnline').onclick = function() {
          showJoin();
          refreshRooms();
        };
        document.getElementById('btnRefreshRooms').onclick = refreshRooms;

        async function refreshRooms() {
          if (!window.__db) {
            console.log('Firebase niet geinitialiseerd. Vul config in.');
            return;
          }
          const select = document.getElementById('roomsList');
          select.innerHTML = '';
          try {
            let snap;
            try {
              // Probeer met index
              snap = await window.__db
                .collection('rooms')
                .where('state','==','matchmaking')
                .orderBy('updatedAt','desc')
                .limit(50)
                .get();
            } catch (err) {
              // Fallback zonder index: haal alles op en filter/sorteer client-side
              console.log('Firestore index ontbreekt, client-side filter/sort wordt gebruikt.');
              snap = await window.__db.collection('rooms').limit(200).get();
              const docs = snap.docs
                .map(d => ({ id: d.id, data: d.data() }))
                .filter(x => x.data && x.data.state === 'matchmaking')
                .sort((a, b) => (b.data.updatedAt || 0) - (a.data.updatedAt || 0));
              if (docs.length === 0) {
                const opt = document.createElement('option');
                opt.value = '';
                opt.textContent = '(geen open rooms)';
                select.appendChild(opt);
              } else {
                docs.forEach(({ id, data }) => {
                  const roomId = id.replace(/^stickfight_/, '');
                  const label = `${roomId} — host: ${data.hostName || '?'} (turn ${data.turn || 1})`;
                  const opt = document.createElement('option');
                  opt.value = roomId;
                  opt.textContent = label;
                  select.appendChild(opt);
                });
              }
              return;
            }
            let found = false;
            if (!snap.empty) {
              snap.forEach(doc => {
                const data = doc.data();
                const id = doc.id.replace(/^stickfight_/, '');
                const label = `${id} — host: ${data.hostName || '?'} (turn ${data.turn || 1})`;
                const opt = document.createElement('option');
                opt.value = id;
                opt.textContent = label;
                select.appendChild(opt);
                found = true;
              });
            }
            if (!found) {
              const opt = document.createElement('option');
              opt.value = '';
              opt.textContent = '(geen open rooms)';
              select.appendChild(opt);
            }
          } catch (e) {
            select.innerHTML = '';
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = '(laden faalde)';
            select.appendChild(opt);
            console.log('Rooms laden faalde:', e && e.message ? e.message : e);
          }
        }

        document.getElementById('roomsList').onchange = function() {
          const val = this.value;
          if (!val) return;
          if (!window.__db) {
            console.log('Vul eerst je Firebase config in (index.html).');
            return;
          }
          game = new Game(currentName());
          game.startOnline(window.__db, val, false);
          hideAllMenus();
        };

        // Join room button
        document.getElementById('btnJoinRoom').onclick = function() {
          const select = document.getElementById('roomsList');
          const val = select.value;
          if (!val) return;
          if (!window.__db) {
            console.log('Vul eerst je Firebase config in (index.html).');
            return;
          }
          game = new Game(currentName());
          game.startOnline(window.__db, val, false);
          hideAllMenus();
        };

        // Back button for joinRow
        document.getElementById('btnJoinBack').onclick = function() {
          showMenu();
        };

        document.getElementById('btnBack').onclick = async function() {
          if (game && typeof game.onBack === 'function') {
            await game.onBack();
          }
          showMenu();
        };

        // Local Create/Join removed

        document.getElementById('btnReset').addEventListener('click', () => {
          game = new Game('Speler');
          logEl.textContent = '';
          updateState();
        });

        // Expose helpers for Game to toggle end-of-game buttons
        window.__showEndButtons = function(show) {
          btnPlayAgain.style.display = show ? '' : 'none';
          btnStopGame.style.display = show ? '' : 'none';
        };

        btnPlayAgain.addEventListener('click', async () => {
          if (game && typeof game.resetOnlineGame === 'function') {
            await game.resetOnlineGame();
            window.__showEndButtons(false);
          }
        });
        btnStopGame.addEventListener('click', async () => {
          if (game && typeof game.stopOnlineGame === 'function') {
            await game.stopOnlineGame();
            window.__showEndButtons(false);
          }
        });
        document.getElementById('btnRefreshRooms').addEventListener('click', refreshRooms);
        document.getElementById('btnUseSelected').addEventListener('click', () => {
          const sel = document.getElementById('roomsList');
          const val = sel.value;
          if (val) document.getElementById('room').value = val;
        });

        ['actAttack','actBlock','actItem','actRun'].forEach(id => {
          document.getElementById(id).addEventListener('click', () => {
            const map = { actAttack: 'attack', actBlock: 'block', actItem: 'item', actRun: 'run' };
            const action = map[id];
            game.submitAction(action);
            updateState();
          });
        });

        // Helpers for UI logic
        window.__enableActions = function(enable) {
          ['actAttack','actBlock','actItem','actRun'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.disabled = !enable;
          });
        };
        window.__resetToMenu = function() {
          // Hide sub-action buttons
          ['subAttackPunch','subAttackKick','subAttackUppercut','subAttackSpecial',
           'subItemHeal','subItemSpeed','subItemDefence'].forEach(id => {
            document.getElementById(id).style.display = 'none';
          });
          // Show main action buttons
          ['actAttack','actBlock','actItem','actRun'].forEach(id => {
            document.getElementById(id).style.display = '';
            document.getElementById(id).disabled = false;
          });
        };

        // Show sub-actions for attack
        document.getElementById('actAttack').addEventListener('click', () => {
          ['actAttack','actBlock','actItem','actRun'].forEach(id => {
            document.getElementById(id).style.display = 'none';
          });
          ['subAttackPunch','subAttackKick','subAttackUppercut','subAttackSpecial'].forEach(id => {
            document.getElementById(id).style.display = '';
            document.getElementById(id).disabled = false;
          });
        });
        // Show sub-actions for item
        document.getElementById('actItem').addEventListener('click', () => {
          ['actAttack','actBlock','actItem','actRun'].forEach(id => {
            document.getElementById(id).style.display = 'none';
          });
          ['subItemHeal','subItemSpeed','subItemDefence'].forEach(id => {
            document.getElementById(id).style.display = '';
            document.getElementById(id).disabled = false;
          });
        });

        // Sub-action handlers for attack
        document.getElementById('subAttackPunch').addEventListener('click', () => {
          game.submitAction({ type: 'attack', sub: 'punch' });
          window.__resetToMenu();
        });
        document.getElementById('subAttackKick').addEventListener('click', () => {
          game.submitAction({ type: 'attack', sub: 'kick' });
          window.__resetToMenu();
        });
        document.getElementById('subAttackUppercut').addEventListener('click', () => {
          game.submitAction({ type: 'attack', sub: 'uppercut' });
          window.__resetToMenu();
        });
        document.getElementById('subAttackSpecial').addEventListener('click', () => {
          game.submitAction({ type: 'attack', sub: 'special' });
          window.__resetToMenu();
        });

        // Sub-action handlers for item
        document.getElementById('subItemHeal').addEventListener('click', () => {
          game.submitAction({ type: 'item', sub: 'heal' });
          window.__resetToMenu();
        });
        document.getElementById('subItemSpeed').addEventListener('click', () => {
          game.submitAction({ type: 'item', sub: 'speed' });
          window.__resetToMenu();
        });
        document.getElementById('subItemDefence').addEventListener('click', () => {
          game.submitAction({ type: 'item', sub: 'defence' });
          window.__resetToMenu();
        });

        // Enable/disable action buttons based on state (optimized with requestAnimationFrame)
        let lastSyncTime = 0;
        function syncControls() {
          const now = performance.now();
          if (now - lastSyncTime < 100) {
            requestAnimationFrame(syncControls);
            return; // Throttle to ~10fps for UI updates
          }
          lastSyncTime = now;
          
          // Enable buttons when playing and no action chosen yet
          let enable = false;
          if (!game.isOnline) {
            // Local play: enable when playing and no action
            enable = game.state === 'playing' && !game.playerAction;
          } else {
            // Online play
            if (game.state === 'playing') {
              // Both players can act when state is playing and they haven't chosen yet
              enable = !game.playerAction;
            }
          }
          
          ['actAttack','actBlock','actItem','actRun'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.disabled = !enable;
          });
          stateEl.textContent = `State: ${game.state} | You: ${game.playerHP} HP vs Opponent: ${game.opponentHP} HP`;
          requestAnimationFrame(syncControls);
        }
        requestAnimationFrame(syncControls);

        updateState();
      })();
    </script>
  </body>
  </html>

