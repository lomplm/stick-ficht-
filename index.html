<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Stick Fight Demo</title>
    <style>
      body { font-family: system-ui, Arial, sans-serif; margin: 24px; }
      .row { display: flex; gap: 12px; margin-bottom: 12px; flex-wrap: wrap; }
      button { padding: 10px 14px; font-size: 14px; cursor: pointer; }
      #log { background: #0b1020; color: #e5ecff; padding: 12px; border-radius: 8px; min-height: 160px; white-space: pre-wrap; }
      .hp { font-weight: bold; }
    </style>
  </head>
  <body>
    <h2>Stick Fight (Demo)</h2>
    <div class="row">
      <input id="playerName" placeholder="Jouw naam" value="Speler" />
      <input id="room" placeholder="Room code (bv. my-room)" />
      <button id="btnHostOnline">Host Online</button>
      <button id="btnJoinOnline">Join Online</button>
      <button id="btnBack" disabled>Back</button>
      <button id="btnReset">Reset</button>
    </div>
    <div class="row">
      <button id="btnRefreshRooms">Refresh Rooms</button>
      <select id="roomsList" style="min-width:240px">
        <option value="">(geen data)</option>
      </select>
      <button id="btnUseSelected">Gebruik selectie</button>
    </div>
    <div class="row">
      <button id="btnPlayAgain" style="display:none">Nog een keer</button>
      <button id="btnStopGame" style="display:none">Stoppen</button>
    </div>
    <div class="row" style="width:100%">
      <canvas id="gameCanvas" width="700" height="320" style="border:1px solid #ccc; background:#f7f9fc; width:100%; max-width:820px"></canvas>
    </div>
    <div class="row">
      <button id="actAttack" disabled>Attack</button>
      <button id="actBlock" disabled>Block</button>
      <button id="actItem" disabled>Item</button>
      <button id="actRun" disabled>Run</button>
    </div>
    <div id="state" class="hp"></div>
    <div id="log" aria-live="polite"></div>

    <script src="Untitled-1.js"></script>
    <!-- Firebase compat SDKs (global firebase.*) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script>
      // 1) Vul je Firebase config hieronder in (Project settings -> Your apps -> SDK setup and configuration)
      // Voorbeeld:
      // const firebaseConfig = { apiKey: "...", authDomain: "...", projectId: "...", storageBucket: "...", messagingSenderId: "...", appId: "..." };
      const firebaseConfig = {
        apiKey: "AIzaSyAs07dGS6aFqshNei3n2edxnaBLrSsfRvA",
        authDomain: "stick-ficht.firebaseapp.com",
        projectId: "stick-ficht",
        storageBucket: "stick-ficht.firebasestorage.app",
        messagingSenderId: "198218024025",
        appId: "1:198218024025:web:b1ade6fd2ab57f6a42dd48",
        measurementId: "G-JCY8JXHB1W"
      };
      let db = null;
      if (firebaseConfig) {
        const app = firebase.initializeApp(firebaseConfig);
        db = firebase.firestore(app);
        window.__db = db; // maak beschikbaar voor game code
      }
    </script>
    <script>
      (function() {
        const logEl = document.getElementById('log');
        const stateEl = document.getElementById('state');
        const originalLog = console.log.bind(console);
        console.log = function(...args) {
          originalLog(...args);
          const line = args.map(String).join(' ');
          logEl.textContent += (logEl.textContent ? '\n' : '') + line;
          logEl.scrollTop = logEl.scrollHeight;
        };

        const nameInput = document.getElementById('playerName');
        function currentName() { return nameInput.value || 'Speler'; }
        let game = new Game(currentName());

        function updateState() {
          stateEl.textContent = `State: ${game.state} | You: ${game.playerHP} HP vs Opponent: ${game.opponentHP} HP`;
        }

        // Local Create/Join removed

        document.getElementById('btnReset').addEventListener('click', () => {
          game = new Game('Speler');
          logEl.textContent = '';
          updateState();
        });

        // Online hosting/joinen via Firestore
        const btnHostOnline = document.getElementById('btnHostOnline');
        const btnJoinOnline = document.getElementById('btnJoinOnline');
        const btnBack = document.getElementById('btnBack');
        const btnPlayAgain = document.getElementById('btnPlayAgain');
        const btnStopGame = document.getElementById('btnStopGame');

        btnHostOnline.addEventListener('click', () => {
          const room = document.getElementById('room').value || 'room-1';
          if (!window.__db) {
            console.log('Vul eerst je Firebase config in (index.html).');
            return;
          }
          game = new Game(currentName());
          game.startOnline(window.__db, room, true);
          updateState();
          // Disable opposite option until Back
          btnJoinOnline.disabled = true;
          btnBack.disabled = false;
        });
        btnJoinOnline.addEventListener('click', () => {
          const room = document.getElementById('room').value || 'room-1';
          if (!window.__db) {
            console.log('Vul eerst je Firebase config in (index.html).');
            return;
          }
          game = new Game(currentName());
          game.startOnline(window.__db, room, false);
          updateState();
          // Disable opposite option until Back
          btnHostOnline.disabled = true;
          btnBack.disabled = false;
        });

        // Back button: leave lobby/match and re-enable options
        btnBack.addEventListener('click', async () => {
          if (game && typeof game.onBack === 'function') {
            await game.onBack();
          }
          btnHostOnline.disabled = false;
          btnJoinOnline.disabled = false;
          btnBack.disabled = true;
          btnPlayAgain.style.display = 'none';
          btnStopGame.style.display = 'none';
        });

        // Rooms lijst ophalen en gebruiken
        async function refreshRooms() {
          if (!window.__db) {
            console.log('Firebase niet geinitialiseerd. Vul config in.');
            return;
          }
          const select = document.getElementById('roomsList');
          select.innerHTML = '';
          try {
            let snap;
            try {
              // Voorkeursquery met sortering (vereist composite index in Firestore)
              snap = await window.__db
                .collection('rooms')
                .where('state','==','matchmaking')
                .orderBy('updatedAt','desc')
                .limit(50)
                .get();
            } catch (err) {
              // Fallback zonder index: haal alle rooms op, filter en sorteer client-side
              console.log('Index ontbreekt; client-side filter/sort wordt gebruikt. Maak de index aan voor betere performance.');
              snap = await window.__db
                .collection('rooms')
                .limit(200)
                .get();
              // Zet om naar array, filter state === matchmaking en sorteer
              const docs = snap.docs
                .map(d => ({ id: d.id, data: d.data(), ref: d.ref }))
                .filter(x => (x.data && x.data.state) === 'matchmaking')
                .sort((a, b) => (b.data.updatedAt || 0) - (a.data.updatedAt || 0));
              // Cleanup: verwijder rooms ouder dan 10 minuten
              const threshold = Date.now() - 10 * 60 * 1000;
              for (const d of docs) {
                if ((d.data.updatedAt || 0) < threshold) {
                  try { await d.ref.delete(); } catch (_) {}
                }
              }
              // Render en return vroegtijdig
              if (docs.length === 0) {
                const opt = document.createElement('option');
                opt.value = '';
                opt.textContent = '(geen open rooms)';
                select.appendChild(opt);
              } else {
                docs.forEach(({ id, data }) => {
                  const room = id.replace(/^stickfight_/, '');
                  const label = `${room} — host: ${data.hostName || '?'} (turn ${data.turn || 1})`;
                  const opt = document.createElement('option');
                  opt.value = room;
                  opt.textContent = label;
                  select.appendChild(opt);
                });
              }
              return;
            }

            if (snap.empty) {
              const opt = document.createElement('option');
              opt.value = '';
              opt.textContent = '(geen open rooms)';
              select.appendChild(opt);
            } else {
              const threshold = Date.now() - 10 * 60 * 1000;
              const removals = [];
              snap.forEach(doc => {
                const data = doc.data();
                if ((data.updatedAt || 0) < threshold) {
                  removals.push(doc.ref.delete().catch(()=>{}));
                } else {
                  const id = doc.id; // stickfight_<room>
                  const room = id.replace(/^stickfight_/, '');
                  const label = `${room} — host: ${data.hostName || '?'} (turn ${data.turn || 1})`;
                  const opt = document.createElement('option');
                  opt.value = room;
                  opt.textContent = label;
                  select.appendChild(opt);
                }
              });
              if (removals.length) { try { await Promise.all(removals); } catch(_) {} }
            }
          } catch (e) {
            console.log('Rooms laden faalde:', e && e.message ? e.message : e);
          }
        }

        // Expose helpers for Game to toggle end-of-game buttons
        window.__showEndButtons = function(show) {
          btnPlayAgain.style.display = show ? '' : 'none';
          btnStopGame.style.display = show ? '' : 'none';
        };

        btnPlayAgain.addEventListener('click', async () => {
          if (game && typeof game.resetOnlineGame === 'function') {
            await game.resetOnlineGame();
            window.__showEndButtons(false);
          }
        });
        btnStopGame.addEventListener('click', async () => {
          if (game && typeof game.stopOnlineGame === 'function') {
            await game.stopOnlineGame();
            window.__showEndButtons(false);
          }
        });
        document.getElementById('btnRefreshRooms').addEventListener('click', refreshRooms);
        document.getElementById('btnUseSelected').addEventListener('click', () => {
          const sel = document.getElementById('roomsList');
          const val = sel.value;
          if (val) document.getElementById('room').value = val;
        });

        ['actAttack','actBlock','actItem','actRun'].forEach(id => {
          document.getElementById(id).addEventListener('click', () => {
            const map = { actAttack: 'attack', actBlock: 'block', actItem: 'item', actRun: 'run' };
            const action = map[id];
            game.submitAction(action);
            updateState();
          });
        });

        // Enable/disable action buttons based on state (polling ensures client enables after host switches to playing)
        function syncControls() {
          const clientMayAct = game.isOnline && !game.isHost && (game.state === 'playing' || game.state === 'matchmaking');
          const enable = (!game.isOnline && game.state === 'playing' && !game.playerAction) || (game.isOnline && (game.isHost ? (game.state === 'playing' && !game.playerAction) : (clientMayAct && !game.playerAction)));
          ['actAttack','actBlock','actItem','actRun'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.disabled = !enable;
          });
          stateEl.textContent = `State: ${game.state} | You: ${game.playerHP} HP vs Opponent: ${game.opponentHP} HP`;
        }
        setInterval(syncControls, 250);

        updateState();
      })();
    </script>
  </body>
  </html>

